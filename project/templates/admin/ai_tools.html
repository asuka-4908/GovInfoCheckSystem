{% extends "base.html" %}
{% block title %}AI数据清洗分析{% endblock %}
{% block content %}
<div class="layui-row layui-col-space15">
  <div class="layui-col-md12">
    <div class="layui-card" style="height: calc(100vh - 110px); display: flex; flex-direction: column;">
      <div class="layui-card-header">
        AI数据清洗与分析
        <div class="layui-form" style="float: right; width: 220px; margin-top: 2px;">
          <select id="engineSelect">
            {% if engines %}
              {% for e in engines %}
              <option value="{{ e.id }}">{{ e.provider_name }} - {{ e.model_name }}</option>
              {% endfor %}
            {% else %}
              <option value="">请先配置并启用引擎</option>
            {% endif %}
          </select>
        </div>
      </div>
      <div class="layui-card-body" style="flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 0;">
        <div class="chat-wrap">
          <div id="chatList" class="chat-list"></div>
        </div>
        <div class="chat-inputbar">
          <textarea id="prompt" class="prompt-input" placeholder="输入与 AI 对话内容，Enter 发送，Shift+Enter 换行"></textarea>
          <button id="btnSend" class="layui-btn send-btn">发送</button>
          <button id="btnStop" class="layui-btn layui-btn-danger send-btn">停止</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<!-- Markdown & Highlight Libraries -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<script>
// Configure marked options
marked.setOptions({
  renderer: new marked.Renderer(),
  highlight: function(code, lang) {
    const language = hljs.getLanguage(lang) ? lang : 'plaintext';
    return hljs.highlight(code, { language }).value;
  },
  langPrefix: 'hljs language-',
  pedantic: false,
  gfm: true,
  breaks: true,
  sanitize: false,
  smartLists: true,
  smartypants: false,
  xhtml: false
});

// Override global functions for this page
window.mdToHtml = function(md) {
  try {
    return marked.parse(md || '');
  } catch (e) {
    console.error('Markdown parse error:', e);
    return md;
  }
};

window.streamSSEToMarkdown = function(container, url) {
  if (!container || !url) return;
  container.innerHTML = '';
  container.className += ' markdown-body'; // Add markdown styling class
  
  var buf = '';
  var es = new EventSource(url);
  
  es.onmessage = function (ev) {
    var chunk = ev.data || '';
    if (chunk === '[DONE]') { 
      es.close(); 
      return; 
    }
    
    // Accumulate buffer
    buf += chunk;
    
    // Render markdown
    container.innerHTML = window.mdToHtml(buf);
    
    // Apply highlighting to new code blocks
    container.querySelectorAll('pre code').forEach((block) => {
      hljs.highlightElement(block);
    });
    
    // Auto scroll
    try { 
      container.scrollIntoView({ behavior: 'smooth', block: 'end' }); 
    } catch (e) { }
  };
  
  es.onerror = function () { 
    try { es.close(); } catch (e) { } 
  };
  
  return es;
};

layui.use(['layer', 'form'], function(){
  var layer = layui.layer;
  var form = layui.form;
  form.render('select');
  var currentES = null;
  var lastTyping = null;
  function pushUserMsg(text){
    var list = document.getElementById('chatList');
    var item = document.createElement('div'); item.className='chat-msg user';
    item.innerHTML = '<div class="role-ava">我</div><div class="msg-body">'+(text?text.replace(/[<>]/g,function(ch){return ({'<':'&lt;','>':'&gt;'}[ch])}) :'')+'</div>';
    list.appendChild(item); try{ item.scrollIntoView({behavior:'smooth',block:'end'}); }catch(e){}
  }
  function pushAiMsg(){
    var list = document.getElementById('chatList');
    var item = document.createElement('div'); item.className='chat-msg ai';
    var body = document.createElement('div'); body.className='msg-body';
    var typing = document.createElement('div'); typing.className='typing'; typing.innerHTML='<span></span><span></span><span></span>';
    item.innerHTML = '<div class="role-ava">AI</div>';
    item.appendChild(body); item.appendChild(typing);
    list.appendChild(item);
    lastTyping = typing;
    return {item:item, body:body, typing:typing};
  }
  function sendPrompt(){
    var prompt = document.getElementById('prompt').value.trim();
    if (!prompt){ layer.msg('请输入内容'); return; }
    pushUserMsg(prompt);
    document.getElementById('prompt').value = '';
    var ai = pushAiMsg();
    var engId = document.getElementById('engineSelect').value;
    var url = '/admin/ai_analyze_stream?prompt=' + encodeURIComponent(prompt);
    if(engId) url += '&engine_id=' + engId;
    try {
      currentES = streamSSEToMarkdown(ai.body, url);
      currentES.onerror = function(){
        try { currentES.close(); } catch(e){}
        console.log("SSE error, switching to fallback demo");
        var fd = new FormData(); fd.append('prompt', prompt);
        if(engId) fd.append('engine_id', engId);
        fetch('/admin/ai_analyze_demo', {method:'POST', body: fd})
          .then(function(r){ 
            if(!r.ok) throw new Error("HTTP error " + r.status);
            return r.json(); 
          })
          .then(function(res){ ai.typing.remove(); if(res.code===0){ ai.body.innerHTML = mdToHtml(res.reply||''); } else { ai.body.textContent = res.msg||'失败'; } })
          .catch(function(err){ 
            console.error("Fallback failed:", err);
            ai.typing.remove(); 
            ai.body.textContent = '网络错误: ' + err.message; 
          });
      };
    } catch(e) { ai.typing.remove(); ai.body.textContent = '启动流式输出失败'; }
  }
  document.getElementById('btnSend').addEventListener('click', sendPrompt);
  document.getElementById('prompt').addEventListener('keydown', function(ev){
    if (ev.key === 'Enter' && !ev.shiftKey){ ev.preventDefault(); sendPrompt(); }
  });
  document.getElementById('btnStop').addEventListener('click', function(){ try{ currentES && currentES.close(); }catch(e){} try{ lastTyping && lastTyping.remove(); }catch(e){} });
});
</script>
<style>
.chat-wrap{ flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:12px; }
.chat-list{ display:flex; flex-direction:column; gap:12px; }
.chat-inputbar{ flex-shrink:0; background:#fff; display:flex; gap:8px; align-items:flex-end; padding:15px; border-top:1px solid #eee }
.prompt-input{ flex:1; min-height:48px; max-height:160px; resize:vertical }
.chat-msg{ display:flex; gap:10px; align-items:flex-start }
.chat-msg.user { flex-direction: row-reverse; }
.chat-msg .role-ava{ width:32px; height:32px; border-radius:50%; background:#1E9FFF; color:#fff; display:flex; align-items:center; justify-content:center; font-size:14px }
.chat-msg.user .role-ava{ background:#5FB878 }
.chat-msg .msg-body{ max-width:80%; width: fit-content; word-break:break-word }
.typing{ display:inline-flex; gap:4px; padding:4px 0 }
.typing span{ width:6px; height:6px; border-radius:50%; background:#bbb; animation:blink 1s infinite }
@keyframes blink{ 0%{opacity:.2} 50%{opacity:1} 100%{opacity:.2} }
.result-table{ table-layout: fixed; }
.result-table th, .result-table td{ word-break: break-all; }
.result-table .cell-clip{ max-height: 40px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; }
.sql-box{ display:none }
.reply-box{ display:none }
/* Markdown Styles */
.markdown-body {
  font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji";
  font-size: 14px;
  line-height: 1.6;
  color: #24292f;
}
.markdown-body h1, .markdown-body h2, .markdown-body h3, .markdown-body h4 {
  margin-top: 24px;
  margin-bottom: 16px;
  font-weight: 600;
  line-height: 1.25;
}
.markdown-body h1 { font-size: 1.8em; border-bottom: 1px solid #eaecef; padding-bottom: .3em; }
.markdown-body h2 { font-size: 1.4em; border-bottom: 1px solid #eaecef; padding-bottom: .3em; }
.markdown-body h3 { font-size: 1.2em; }
.markdown-body p { margin-bottom: 16px; }
.markdown-body ul, .markdown-body ol { padding-left: 2em; margin-bottom: 16px; }
.markdown-body li { margin-top: 0.25em; }
.markdown-body pre {
  padding: 16px;
  overflow: auto;
  font-size: 85%;
  line-height: 1.45;
  background-color: #2d2d2d;
  border-radius: 6px;
  margin-bottom: 16px;
  color: #e6edf3;
}
.markdown-body code {
  padding: .2em .4em;
  margin: 0;
  font-size: 85%;
  background-color: rgba(175,184,193,0.2);
  border-radius: 6px;
  font-family: ui-monospace,SFMono-Regular,SF Mono,Menlo,Consolas,Liberation Mono,monospace;
}
.markdown-body pre code {
  padding: 0;
  background-color: transparent;
  color: inherit;
  white-space: pre;
}
.markdown-body blockquote {
  padding: 0 1em;
  color: #656d76;
  border-left: .25em solid #d0d7de;
  margin: 0 0 16px 0;
}
.markdown-body table {
  border-spacing: 0;
  border-collapse: collapse;
  margin-bottom: 16px;
  width: 100%;
  display: block;
  overflow: auto;
}
.markdown-body table th, .markdown-body table td {
  padding: 6px 13px;
  border: 1px solid #d0d7de;
}
.markdown-body table th {
  font-weight: 600;
  background-color: #f6f8fa;
}
.markdown-body table tr:nth-child(2n) {
  background-color: #f6f8fa;
}
/* User message style fix */
.chat-msg.user .msg-body {
  background-color: #95ec69;
  padding: 10px 14px;
  border-radius: 8px;
  font-size: 14px;
}
.chat-msg.ai .msg-body {
  background-color: #fff;
  padding: 12px 16px;
  border-radius: 8px;
  border: 1px solid #eee;
}

</style>
{% endblock %}
