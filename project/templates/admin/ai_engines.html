{% extends "base.html" %}

{% block title %}AI引擎管理 - {{ settings.app_name }}{% endblock %}

{% block content %}
<div class="layui-card">
  <div class="layui-card-header">AI引擎管理</div>
  <div class="layui-card-body">
    <div class="layui-form" style="margin-bottom:10px;display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <div class="layui-inline">
        <input type="text" id="q" value="{{ q }}" placeholder="服务商/模型名称" class="layui-input" style="width:260px">
      </div>
      <div class="layui-inline op-actions">
        <button class="layui-btn" id="btnSearch">查询</button>
        <button class="layui-btn layui-btn-normal" id="btnRefresh">刷新</button>
        <button class="layui-btn layui-btn-warm" id="btnAdd"><i class="layui-icon layui-icon-add-circle"></i>新增引擎</button>
      </div>
    </div>
    <div class="engine-grid">
      {% for r in rows %}
      <div class="engine-card" data-id="{{ r.id }}" data-enabled="{{ r.enabled }}">
        <div class="engine-top">
          <div class="engine-badge">{{ r.provider_name }}</div>
          <div class="engine-model">{{ r.model_name }}</div>
        </div>
        <div class="engine-body">
          <div class="engine-field">API URL：<span title="{{ r.api_url }}">{{ r.api_url }}</span></div>
          <div class="engine-field">API Key：<span class="mask">{{ r.api_key[:4] }}****{{ r.api_key[-4:] if r.api_key|length>8 else '' }}</span></div>
          <div class="engine-field">状态：<span class="tag {{ 'on' if r.enabled==1 else 'off' }}">{{ '启用' if r.enabled==1 else '停用' }}</span></div>
        </div>
      <div class="engine-actions">
        <button class="layui-btn layui-btn-sm" data-action="edit"><i class="layui-icon layui-icon-edit"></i>编辑</button>
        <button class="layui-btn layui-btn-sm layui-btn-danger" data-action="del"><i class="layui-icon layui-icon-delete"></i>删除</button>
        <button class="layui-btn layui-btn-sm layui-btn-normal" data-action="chat"><i class="layui-icon layui-icon-chat"></i>对话</button>
      </div>
      </div>
      {% endfor %}
      {% if rows|length == 0 %}
      <div style="color:#999;padding:20px">暂无引擎，请点击“新增引擎”进行添加</div>
      {% endif %}
    </div>
  </div>
</div>
<style>
.engine-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));grid-gap:16px}
.engine-card{border:1px solid var(--border);border-radius:12px;background:#fff;color:#333;box-shadow:0 8px 20px rgba(0,0,0,.05);position:relative;overflow:hidden}
.engine-top{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.engine-badge{font-size:13px;background:#f3f5f9;color:#333;display:inline-block;padding:4px 10px;border-radius:999px;font-weight:600}
.engine-model{font-size:14px;color:#666;font-weight:600}
.engine-body{padding:12px 16px;background:#fff}
.engine-field{font-size:13px;margin-bottom:6px;word-break:break-all}
.engine-actions{display:flex;gap:8px;padding:12px 16px;border-top:1px solid var(--border);background:#fafbfc}
.mask{letter-spacing:.4px;background:#f5f7fa;border-radius:6px;padding:0 6px}
.tag{display:inline-block;padding:2px 10px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
.tag.on{background:rgba(95,184,120,.12);color:#2F9688}
.tag.off{background:rgba(255,87,34,.12);color:#FF5722}
</style>
{% endblock %}

{% block scripts %}
<script>
layui.use(['layer','form'], function(){
  var layer = layui.layer;
  var form = layui.form;
  var BASE = "{{ base_prefix or '/admin' }}";
  document.getElementById('btnSearch').addEventListener('click', function(){
    var q = document.getElementById('q').value.trim();
    location.href = BASE + '/ai_engines?q=' + encodeURIComponent(q);
  });
  document.getElementById('btnRefresh').addEventListener('click', function(){ location.href = BASE + '/ai_engines'; });
  document.getElementById('btnAdd').addEventListener('click', function(){
    var html = '<div style="padding:12px">'
      +'<div class="layui-form-item"><label class="layui-form-label">服务商</label><div class="layui-input-block"><input id="f_provider" class="layui-input"></div></div>'
      +'<div class="layui-form-item"><label class="layui-form-label">API URL</label><div class="layui-input-block"><input id="f_url" class="layui-input" placeholder="https://api.openai.com/v1"></div></div>'
      +'<div class="layui-form-item"><label class="layui-form-label">API Key</label><div class="layui-input-block"><input id="f_key" class="layui-input" type="password"></div></div>'
      +'<div class="layui-form-item"><label class="layui-form-label">模型</label><div class="layui-input-block"><input id="f_model" class="layui-input" placeholder="gpt-4o-mini"></div></div>'
      +'</div>';
    layer.open({type:1,title:'新增引擎',area:['520px','420px'],content:html,btn:['保存','取消'],yes:function(){
      var fd = new FormData();
      fd.append('provider_name', document.getElementById('f_provider').value.trim());
      fd.append('api_url', document.getElementById('f_url').value.trim());
      fd.append('api_key', document.getElementById('f_key').value);
      fd.append('model_name', document.getElementById('f_model').value.trim());
      fd.append('enabled', '1');
      fetch(BASE + '/ai_engines/add', {method:'POST', body: fd})
        .then(function(r){return r.json();})
        .then(function(res){ if (res.code===0){ layer.msg('已添加'); setTimeout(function(){ location.reload(); }, 500);} else { layer.msg(res.msg||'失败'); } });
    }});
  });
  document.querySelector('.engine-grid').addEventListener('click', function(e){
    var t = e.target;
    var card = t.closest('.engine-card');
    if (!card) return;
    var id = card.getAttribute('data-id');
    if (t.dataset.action === 'edit'){
      var provider = card.querySelector('.engine-badge').textContent.trim();
      var model = card.querySelector('.engine-model').textContent.trim();
      var url = card.querySelector('.engine-body .engine-field span').getAttribute('title');
      var enVal = card.getAttribute('data-enabled') === '1';
      var html = '<div class="layui-form" style="padding:12px" lay-filter="edit_engine">'
        +'<div class="layui-form-item"><label class="layui-form-label">服务商</label><div class="layui-input-block"><input id="f_provider" value="'+provider+'" class="layui-input"></div></div>'
        +'<div class="layui-form-item"><label class="layui-form-label">API URL</label><div class="layui-input-block"><input id="f_url" value="'+(url||'')+'" class="layui-input"></div></div>'
        +'<div class="layui-form-item"><label class="layui-form-label">API Key</label><div class="layui-input-block"><input id="f_key" class="layui-input" type="password" placeholder="留空不变"></div></div>'
        +'<div class="layui-form-item"><label class="layui-form-label">模型</label><div class="layui-input-block"><input id="f_model" value="'+model+'" class="layui-input"></div></div>'
        +'<div class="layui-form-item"><label class="layui-form-label">启用</label><div class="layui-input-block"><input type="checkbox" id="f_enabled" '+(enVal?'checked':'')+' lay-skin="switch" lay-text="启用|停用"></div></div>'
        +'</div>';
      layer.open({type:1,title:'编辑引擎',area:['520px','460px'],content:html,btn:['保存','取消'],
      success: function(){ form.render(null, 'edit_engine'); },
      yes:function(){
        var fd = new FormData();
        fd.append('provider_name', document.getElementById('f_provider').value.trim());
        fd.append('api_url', document.getElementById('f_url').value.trim());
        var k = document.getElementById('f_key').value;
        if (k){ fd.append('api_key', k); } else { fd.append('api_key', ''); }
        fd.append('model_name', document.getElementById('f_model').value.trim());
        fd.append('enabled', document.getElementById('f_enabled').checked ? '1' : '0');
        fetch(BASE + '/ai_engines/update/'+id, {method:'POST', body: fd})
          .then(function(r){return r.json();})
          .then(function(res){ if (res.code===0){ layer.msg('已更新'); setTimeout(function(){ location.reload(); }, 500);} else { layer.msg(res.msg||'失败'); } });
      }});
    }
    if (t.dataset.action === 'del'){
      layer.confirm('确认删除该引擎？',{icon:3}, function(){
        fetch(BASE + '/ai_engines/delete/'+id, {method:'POST'})
          .then(function(r){return r.json();})
          .then(function(res){ if (res.code===0){ layer.msg('已删除'); setTimeout(function(){ location.reload(); }, 500);} else { layer.msg(res.msg||'失败'); } });
      });
    }
    if (t.dataset.action === 'chat'){
      var html = ''
        +'<div class="chat-wrap">'
        +  '<div class="chat-header">AI对话 - 引擎ID '+id+'</div>'
        +  '<div id="chatList" class="chat-list"></div>'
        +  '<div class="chat-input">'
        +    '<textarea id="chatPrompt" class="layui-textarea" placeholder="输入内容，Enter发送，Shift+Enter换行"></textarea>'
        +    '<button id="chatSend" class="layui-btn layui-btn-normal">发送</button>'
        +  '</div>'
        +'</div>';
      layer.open({type:1,title:false,shade:0.2,area:['760px','620px'],content:html});
      var msgs = [];
      var list = document.getElementById('chatList');
      var promptEl = document.getElementById('chatPrompt');
      var sendBtn = document.getElementById('chatSend');
      function render(){
        list.innerHTML = msgs.map(function(m){
          var cls = m.role === 'user' ? 'msg user' : (m.role === 'assistant' ? 'msg ai' : 'msg sys');
          return '<div class="'+cls+'"><div class="bubble">'+(m.content||'')+'</div></div>';
        }).join('');
        list.scrollTop = list.scrollHeight;
      }
      function send(){
        var text = promptEl.value.trim();
        if (!text) return;
        msgs.push({role:'user', content:text});
        render();
        promptEl.value='';
        sendBtn.disabled = true;
        sendBtn.textContent = '发送中...';
        var fd = new FormData();
        fd.append('engine_id', id);
        fd.append('prompt', text);
        fd.append('messages', JSON.stringify(msgs));
        fetch(BASE + '/ai_chat', {method:'POST', body: fd})
          .then(function(r){return r.json();})
          .then(function(res){
            if (res.code===0){ msgs.push({role:'assistant', content: res.reply||''}); }
            else { msgs.push({role:'assistant', content: (res.msg||'失败') + (res.err? ('\n'+res.err):'')}); }
            render();
          })
          .catch(function(){ msgs.push({role:'assistant', content:'网络错误'}); render(); })
          .finally(function(){ sendBtn.disabled=false; sendBtn.textContent='发送'; });
      }
      sendBtn.addEventListener('click', send);
      promptEl.addEventListener('keydown', function(e){
        if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); send(); }
      });
    }
  });
});
</script>
<style>
.chat-wrap{display:flex;flex-direction:column;height:100%}
.chat-header{padding:10px 12px;border-bottom:1px solid #eee;font-weight:600}
.chat-list{flex:1;overflow:auto;padding:12px;gap:10px;background:#f7f7f7}
.chat-input{display:flex;gap:8px;padding:12px;border-top:1px solid #eee}
.chat-input textarea{flex:1;height:80px}
.msg{display:flex;margin:8px 0}
.msg.user{justify-content:flex-end}
.msg.ai{justify-content:flex-start}
.bubble{max-width:70%;padding:8px 10px;border-radius:8px;white-space:pre-wrap;word-break:break-word}
.msg.user .bubble{background:#409eff;color:#fff}
.msg.ai .bubble{background:#e6e6e6;color:#333}
</style>
{% endblock %}
