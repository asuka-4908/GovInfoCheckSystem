{% extends "base.html" %}

{% block title %}数据仓库管理 - {{ settings.app_name }}{% endblock %}

{% block content %}
<div class="layui-card">
  <div class="layui-card-header">数据仓库管理</div>
  <div class="layui-card-body">
    <div class="layui-form warehouse-toolbar" style="margin-bottom:10px;display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <div class="layui-inline">
        <input type="text" id="q" value="{{ q }}" placeholder="关键词/标题/摘要" class="layui-input" style="width:260px">
      </div>
      <div class="layui-inline">
        <button class="layui-btn" id="btnSearch">查询</button>
        <button class="layui-btn layui-btn-normal" id="btnRefresh">刷新</button>
        <button class="layui-btn layui-btn-danger" id="btnBatchDelete">批量删除</button>
        <button class="layui-btn layui-btn-normal" id="btnBatchDeep">批量深度采集</button>
      </div>
    </div>
    <table class="layui-table warehouse-table">
      <colgroup>
        <col style="width:44px">
        <col style="width:70px">
        <col style="width:200px">
        <col style="width:120px">
        <col style="width:120px">
        <col style="width:160px">
        <col style="width:360px">
      </colgroup>
      <thead>
        <tr>
          <th class="col-check"><input type="checkbox" id="checkAll"></th>
          <th>序号</th>
          <th class="col-title">标题</th>
          <th class="col-source">来源</th>
          <th class="col-keyword">关键词</th>
          <th class="col-time">创建时间</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr data-id="{{ r.id }}" data-cover="{{ r.cover or '' }}" data-url="{{ r.url }}">
          <td class="col-check"><input type="checkbox" class="row-check" value="{{ r.id }}"></td>
          <td>{{ (page - 1) * page_size + loop.index }}</td>
          <td class="col-title"><div class="cell-clip"><a href="{{ r.url }}" target="_blank" rel="noopener noreferrer">{{ r.title }}</a></div></td>
          <td class="col-source">{{ r.source }}</td>
          <td class="col-keyword">{{ r.keyword }}</td>
          <td class="col-time">{{ r.created_at }}</td>
          <td>
            <div class="op-actions">
              <button class="layui-btn layui-btn-sm" data-action="edit"><i
                  class="layui-icon layui-icon-edit"></i>编辑</button>
              <button class="layui-btn layui-btn-sm layui-btn-danger" data-action="del"><i
                  class="layui-icon layui-icon-delete"></i>删除</button>
              <button class="layui-btn layui-btn-sm layui-btn-primary" data-action="detail"><i
                  class="layui-icon layui-icon-survey"></i>详细</button>
              <button class="layui-btn layui-btn-sm layui-btn-warm" data-action="analyze"><i
                  class="layui-icon layui-icon-chart-screen"></i>AI解析</button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="layui-form pager-wrap" style="margin-top:10px;display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:center">
      <div class="layui-inline" style="display:flex;align-items:center;gap:8px">
        <label class="layui-form-label" style="width:auto;padding-right:8px">每页</label>
        <div class="layui-input-inline" style="width:110px">
          <input type="number" id="pageSizeInput" value="{{ page_size }}" min="1" max="200" class="layui-input">
        </div>
      </div>
      <div class="layui-inline op-actions">
        <button class="layui-btn layui-btn-primary" id="btnPrev">上一页</button>
        <button class="layui-btn layui-btn-primary" id="btnNext">下一页</button>
      </div>
      <div class="layui-inline" style="color:#999">共 {{ total }} 条，{{ pages }} 页</div>
      <div class="layui-inline" style="display:flex;align-items:center;gap:8px">
        <label class="layui-form-label" style="width:auto;padding-right:8px">页数</label>
        <div class="layui-input-inline" style="width:110px">
          <input type="number" id="pageInput" value="{{ page }}" min="1" max="{{ pages }}" class="layui-input">
        </div>
        <button class="layui-btn" id="btnGo">跳转</button>
      </div>
    </div>
  </div>
  {% endblock %}

  {% block scripts %}
  <script>
    layui.use(['layer', 'form'], function () {
      var layer = layui.layer;
      var form = layui.form;
      var pages = {{ pages }};
      var page = {{ page }};
      var pageSize = {{ page_size }};
      var BASE = "{{ base_prefix or '/admin' }}";
      function goto(p, ps){
        if (p < 1) p = 1;
        if (p > pages) p = pages;
        var q = document.getElementById('q').value.trim();
        var url = BASE + '/warehouse?page=' + p + '&page_size=' + ps;
        if (q) url += '&q=' + encodeURIComponent(q);
        location.href = url;
      }
      document.getElementById('btnSearch').addEventListener('click', function () {
        var q = document.getElementById('q').value.trim();
        var psEl = document.getElementById('pageSizeInput');
        var ps = (psEl ? parseInt(psEl.value) : pageSize) || pageSize;
        var url = BASE + '/warehouse?page=1&page_size=' + ps;
        if (q) url += '&q=' + encodeURIComponent(q);
        location.href = url;
      });
      document.getElementById('btnRefresh').addEventListener('click', function () { location.href = BASE + '/warehouse?page=1&page_size=' + pageSize; });
      var psInput = document.getElementById('pageSizeInput');
      if (psInput){
        var psTimer = null;
        function applyPageSize(){ var val = parseInt(psInput.value)||pageSize; if (val < 1) val = 1; if (val > 200) val = 200; goto(1, val); }
        function schedule(){ if (psTimer){ clearTimeout(psTimer); } psTimer = setTimeout(applyPageSize, 500); }
        psInput.addEventListener('input', schedule);
        psInput.addEventListener('keyup', function(e){ if (e.key === 'Enter'){ applyPageSize(); } });
      }
      document.getElementById('btnPrev').addEventListener('click', function(){ goto(page-1, pageSize); });
      document.getElementById('btnNext').addEventListener('click', function(){ goto(page+1, pageSize); });
      document.getElementById('btnGo').addEventListener('click', function(){ var p = parseInt(document.getElementById('pageInput').value)||page; goto(p, pageSize); });
      try{ form.render(); }catch(e){}
      // 批量选择
      var checkAll = document.getElementById('checkAll');
      if (checkAll) {
        checkAll.addEventListener('change', function(){
          document.querySelectorAll('.row-check').forEach(function(cb){ cb.checked = checkAll.checked; });
        });
      }
      function getSelectedIds(){ return Array.from(document.querySelectorAll('.row-check:checked')).map(function(cb){ return parseInt(cb.value); }).filter(Boolean); }
      // 批量删除
      document.getElementById('btnBatchDelete').addEventListener('click', function(){
        var ids = getSelectedIds();
        if (!ids.length){ layer.msg('请先选择要删除的条目'); return; }
        layer.confirm('确认批量删除选中条目及其详细？',{icon:3}, function(){
          fetch(BASE + '/warehouse/batch_delete', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ids: ids }) })
            .then(function(r){ return r.json(); })
            .then(function(res){ if (res.code===0){ layer.msg('已删除 '+(res.count||ids.length)+' 条'); setTimeout(function(){ location.reload(); }, 600); } else { layer.msg(res.msg||'失败'); } });
        });
      });
      // 批量深度采集
      document.getElementById('btnBatchDeep').addEventListener('click', function(){
        var ids = getSelectedIds();
        if (!ids.length){ layer.msg('请先选择要采集的条目'); return; }
        layer.msg('开始批量深度采集…');
          fetch(BASE + '/warehouse/batch_collect', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ids: ids }) })
          .then(function(r){ return r.json(); })
          .then(function(res){ if (res.code===0){ layer.msg('已采集 '+(res.count||ids.length)+' 条'); } else { layer.msg(res.msg||'失败'); } });
      });
      document.querySelector('table').addEventListener('click', function (e) {
        var t = e.target.closest('button');
        if (!t) return;
        var tr = t.closest('tr');
        if (!tr) return;
        var id = tr.getAttribute('data-id');
        if (t.dataset.action === 'edit') {
          var title = tr.children[1].textContent.trim();
          var source = tr.children[2].textContent.trim();
          var keyword = tr.children[3].textContent.trim();
          var url = tr.getAttribute('data-url') || (tr.children[1].querySelector('a') && tr.children[1].querySelector('a').getAttribute('href')) || '';
          var cover = tr.getAttribute('data-cover') || '';
          var html = '<div style="padding:10px">'
            + '<div class="layui-form-item"><label class="layui-form-label">标题</label><div class="layui-input-block"><input id="f_title" value="' + (title || '') + '" class="layui-input"></div></div>'
            + '<div class="layui-form-item"><label class="layui-form-label">摘要</label><div class="layui-input-block"><textarea id="f_summary" class="layui-textarea"></textarea></div></div>'
            + '<div class="layui-form-item"><label class="layui-form-label">封面</label><div class="layui-input-block"><input id="f_cover" value="' + (cover || '') + '" class="layui-input"></div></div>'
            + '<div class="layui-form-item"><label class="layui-form-label">链接</label><div class="layui-input-block"><input id="f_url" value="' + (url || '') + '" class="layui-input"></div></div>'
            + '<div class="layui-form-item"><label class="layui-form-label">来源</label><div class="layui-input-block"><input id="f_source" value="' + (source || '') + '" class="layui-input"></div></div>'
            + '<div class="layui-form-item"><label class="layui-form-label">关键词</label><div class="layui-input-block"><input id="f_keyword" value="' + (keyword || '') + '" class="layui-input"></div></div>'
            + '</div>';
          layer.open({
            type: 1, title: '编辑', area: ['600px', '520px'], content: html, btn: ['保存', '取消'], yes: function () {
              var fd = new FormData();
              fd.append('title', document.getElementById('f_title').value);
              fd.append('summary', document.getElementById('f_summary').value);
              fd.append('cover', document.getElementById('f_cover').value);
              fd.append('url', document.getElementById('f_url').value);
              fd.append('source', document.getElementById('f_source').value);
              fd.append('keyword', document.getElementById('f_keyword').value);
              fetch(BASE + '/warehouse/update/' + id, { method: 'POST', body: fd })
                .then(function (r) { return r.json(); })
                .then(function (res) { if (res.code === 0) { layer.msg('已保存'); setTimeout(function () { location.reload(); }, 500); } else { layer.msg(res.msg || '失败'); } });
            }
          });
        }
        if (t.dataset.action === 'del') {
          layer.confirm('确认删除该条数据及其详细？', { icon: 3 }, function () {
            fetch(BASE + '/warehouse/delete/' + id, { method: 'POST' })
              .then(function (r) { return r.json(); })
              .then(function (res) { if (res.code === 0) { layer.msg('已删除'); setTimeout(function () { location.reload(); }, 500); } else { layer.msg(res.msg || '失败'); } });
          });
        }
        if (t.dataset.action === 'detail') {
          fetch(BASE + '/warehouse/detail/' + id)
            .then(function (r) { return r.json(); })
            .then(function (res) { var d = res.detail || {}; var txt = d.content_text || ''; var html = d.content_html || ''; layer.open({ type: 1, title: '详细内容', area: ['800px', '600px'], content: '<div style="padding:10px"><div style="margin-bottom:8px;color:#666">正文（文本）</div><div style="max-height:200px;overflow:auto;white-space:pre-wrap">' + txt + '</div><div style="margin-top:12px;color:#666">原文（HTML）</div><div style="max-height:260px;overflow:auto;">' + html + '</div></div>' }); });
        }
        if (t.dataset.action === 'analyze') {
          layer.msg('AI解析中...', { icon: 16, shade: 0.2, time: 0 });
          fetch(BASE + '/warehouse/analyze/' + id, { method: 'POST' })
            .then(function (r) { return r.json(); })
            .then(function (res) {
              layer.closeAll();
              if (res.code === 0) {
                var summary = res.summary || '';
                layer.open({ type: 1, title: 'AI解析摘要', area: ['720px', '420px'], shadeClose: true, content: '<div style="padding:12px"><div style="color:#666;margin-bottom:8px">解析结果</div><div style="white-space:pre-wrap;word-break:break-word">'+ summary +'</div></div>' });
              } else {
                layer.msg(res.msg || '解析失败');
              }
            })
            .catch(function(){ layer.closeAll(); layer.msg('网络错误'); });
        }
      });
    });
  </script>
  <style>
    .warehouse-table { table-layout: fixed; width: 100%; }
    .warehouse-table th, .warehouse-table td { word-break: break-all; }
    .warehouse-table .cell-clip { max-height: 24px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
    .warehouse-table .op-actions { flex-wrap: nowrap; gap: 4px }
    .warehouse-table .op-actions .layui-btn { padding: 0 8px }
    .warehouse-toolbar{ position: sticky; top: 0; z-index: 9; background: #fff; padding: 6px 0 }
    @media (max-width: 1260px){ .warehouse-table th.col-time, .warehouse-table td.col-time{ display:none; } }
    
    @media (max-width: 1080px){ .warehouse-table th.col-keyword, .warehouse-table td.col-keyword{ display:none; } }
    @media (max-width: 960px){ .warehouse-table th.col-source, .warehouse-table td.col-source{ display:none; } }
  </style>
  {% endblock %}
