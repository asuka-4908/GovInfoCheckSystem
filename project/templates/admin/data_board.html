{% extends "base.html" %}

{% block title %}数据大屏 - {{ settings.app_name }}{% endblock %}

{% block content %}
<div class="layui-row" style="gap: 15px;">
  <div class="layui-col-md8">
    <div class="layui-card" style="background: linear-gradient(135deg,#0f2027,#203a43,#2c5364); color:#fff;">
      <div class="layui-card-header" style="color:#fff;">全国地区热力图</div>
      <div class="layui-card-body" style="height:560px;">
        <div id="chinaMap" style="width:100%;height:520px;"></div>
      </div>
    </div>
  </div>
  <div class="layui-col-md4">
    <div class="layui-card" style="background:#0b1b2b;color:#9cd0ff;">
      <div class="layui-card-header" style="color:#9cd0ff;">热点地区排行</div>
      <div class="layui-card-body" style="height:560px;">
        <div id="topRegions" style="width:100%;height:520px;"></div>
      </div>
    </div>
  </div>
</div>

<div class="layui-row" style="margin-top: 15px;">
  <div class="layui-col-md12">
    <div class="layui-card">
      <div class="layui-card-header">最新采集数据（20条）</div>
      <div class="layui-card-body">
        <table class="layui-table">
          <colgroup>
            <col style="width:44px">
            <col style="width:360px">
            <col style="width:160px">
            <col style="width:160px">
            <col style="width:120px">
          </colgroup>
          <thead>
            <tr>
              <th>#</th>
              <th>标题</th>
              <th>来源</th>
              <th>关键词</th>
              <th>时间</th>
            </tr>
          </thead>
          <tbody id="latestTbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://fastly.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script>
(function(){
  var mapEl = document.getElementById('chinaMap');
  var topEl = document.getElementById('topRegions');
  var latestTbody = document.getElementById('latestTbody');
  var mapChart = echarts.init(mapEl);
  var topChart = echarts.init(topEl);
  function renderLatest(rows){
    var html = '';
    for(var i=0;i<rows.length;i++){
      var r = rows[i];
      var idx = i+1;
      var title = (r.title||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      var src = (r.source||'');
      var kw = (r.keyword||'');
      var tm = (r.created_at||'');
      html += '<tr>'+
        '<td>'+idx+'</td>'+
        '<td><div class="cell-clip"><a href="'+(r.url||'#')+'" target="_blank" rel="noopener noreferrer">'+title+'</a></div></td>'+
        '<td>'+src+'</td>'+
        '<td>'+kw+'</td>'+
        '<td>'+tm+'</td>'+
      '</tr>';
    }
    latestTbody.innerHTML = html;
  }
  function loadLatest(){
    fetch('/admin/data_board/latest').then(function(r){return r.json();}).then(function(res){
      if(res.code===0){ renderLatest(res.rows||[]); }
    });
  }
  function loadMap(){
    fetch('https://fastly.jsdelivr.net/npm/echarts@5/map/json/china.json').then(function(r){return r.json();}).then(function(chinaJson){
      echarts.registerMap('china', chinaJson);
      fetch('/admin/data_board/heatmap').then(function(r){return r.json();}).then(function(res){
        if(res.code!==0) return;
        var mapData = res.map||[];
        var regions = (mapData||[]).slice().sort(function(a,b){return (b.value||0)-(a.value||0);}).slice(0,10);
        var names = regions.map(function(x){return x.name});
        var vals = regions.map(function(x){return x.value});
        var mapOpt = {
          backgroundColor: 'transparent',
          tooltip: { trigger: 'item' },
          visualMap: { min: 0, max: Math.max.apply(null, vals.concat([10])), left: 'left', top: 'bottom', text: ['高','低'], calculable: true, inRange: { color: ['#73c0de','#3ba272','#fc8452','#d7000f'] } },
          series: [{ type: 'map', map: 'china', roam: true, label: { show: false }, itemStyle: { areaColor: '#0f2b47', borderColor: '#175f8c' }, emphasis: { label: { show: true }, itemStyle: { areaColor: '#1b5d86' } }, data: mapData }]
        };
        var barOpt = {
          backgroundColor: 'transparent',
          grid: { left: 30, right: 16, top: 24, bottom: 38 },
          xAxis: { type: 'category', data: names, axisLabel: { color: '#9cd0ff' } },
          yAxis: { type: 'value', axisLabel: { color: '#9cd0ff' } },
          tooltip: { trigger: 'axis' },
          series: [{ type: 'bar', data: vals, itemStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:'#5fb878'},{offset:.7,color:'#38a39a'},{offset:1,color:'#1E9FFF'}]) } }]
        };
        mapChart.setOption(mapOpt);
        topChart.setOption(barOpt);
      });
    });
  }
  loadLatest();
  loadMap();
  setInterval(function(){ loadLatest(); loadMap(); }, 60000);
})();
</script>
{% endblock %}

